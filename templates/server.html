<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Invoice Classifier - Server</title>
<style>
body { font-family: system-ui, sans-serif; margin: 2rem; max-width: 1200px; }
h2 { margin-top: 0; }
h3 { margin-top: 1.5rem; margin-bottom: 0.5rem; }
.row { display: flex; gap: 1rem; flex-wrap: wrap; margin: 1rem 0; }
button { font-size: 1rem; padding: 0.75rem 1.2rem; border-radius: 8px; border: 1px solid #ccc; background: white; cursor: pointer; }
button:hover { background: #f5f5f5; }
button.loading { background-color: #e0e0e0; pointer-events: none; }
button.success { background-color: #d8f5d0; }
button.error { background-color: #ffd6d6; }
button.small { font-size: 0.9rem; padding: 0.5rem 0.8rem; }
button.primary { background-color: #4a90e2; color: white; border-color: #4a90e2; }
button.primary:hover { background-color: #357abd; }
.ml-status { background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 6px; padding: 0.75rem; margin: 1rem 0; }
.ml-status.ready { background-color: #d8f5d0; }
.ml-status.error { background-color: #ffd6d6; }
.expense-summary { background-color: #f0f8ff; border: 1px solid #4a90e2; border-radius: 8px; padding: 1rem; margin: 1rem 0; }
.file-list { background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin: 1rem 0; }
.file-item { display: flex; align-items: center; gap: 1rem; padding: 0.75rem; margin: 0.5rem 0; background: white; border-radius: 6px; border: 1px solid #eee; }
.file-item.classified { border-left: 4px solid #4a90e2; }
.file-item.unclassified { border-left: 4px solid #ffa500; }
.file-info { flex: 1; }
.file-name { font-weight: bold; }
.file-meta { font-size: 0.9rem; color: #666; margin-top: 0.25rem; }
.category-badge { display: inline-block; background-color: #4a90e2; color: white; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.85rem; margin-right: 0.5rem; }
.confidence { color: #666; font-size: 0.85rem; }
.status-message { padding: 1rem; margin: 1rem 0; border-radius: 6px; }
.status-message.success { background-color: #d8f5d0; border: 1px solid #4caf50; }
.status-message.error { background-color: #ffd6d6; border: 1px solid #f44336; }
.status-message.info { background-color: #e3f2fd; border: 1px solid #2196f3; }
table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #ddd; }
th { background-color: #f5f5f5; font-weight: bold; }
</style>
</head>
<body>
<h2>ðŸ“Š Invoice Classifier - Server</h2>

<div id="mlStatus" class="ml-status">Checking ML status...</div>

<div id="expenseSummary" class="expense-summary" style="display: none;">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    <div>
      <strong>Expense Summary:</strong> <span id="expenseTotal">$0.00</span> from <span id="expenseCount">0</span> invoices
    </div>
    <button onclick="downloadExpenses()" class="small primary">Download CSV</button>
  </div>
  <div id="expenseBreakdown" style="margin-top: 1rem;"></div>
</div>

<div class="row">
  <button onclick="classifyAll()" class="primary" id="classifyAllBtn">Classify All Files</button>
  <button onclick="refreshFiles()" class="small">Refresh File List</button>
</div>

<div id="statusMessage"></div>

<div class="file-list">
  <h3>Scanned Files</h3>
  <div id="fileList">Loading files...</div>
</div>

<script>
const TOKEN = "{{ token or 'changeme' }}";

function authHeaders() {
  return {'X-Auth': TOKEN};
}

async function checkMLStatus() {
  const r = await fetch('/api/ml/status', {headers: authHeaders()});
  const j = await r.json();
  const statusEl = document.getElementById('mlStatus');
  if (j.ok && j.ml_available && j.model_loaded) {
    statusEl.className = 'ml-status ready';
    statusEl.textContent = `âœ“ ML Ready: ${j.model_type} model with ${j.categories?.length || 0} categories`;
  } else {
    statusEl.className = 'ml-status error';
    statusEl.textContent = `âœ— ML Not Available: ${j.error || 'Model not loaded'}`;
  }
}

async function checkExpenseSummary() {
  const r = await fetch('/api/expenses/summary', {headers: authHeaders()});
  const j = await r.json();
  if (j.ok && j.total > 0) {
    document.getElementById('expenseSummary').style.display = 'block';
    document.getElementById('expenseTotal').textContent = `$${j.total.toFixed(2)}`;
    document.getElementById('expenseCount').textContent = j.count;
    
    const breakdown = document.getElementById('expenseBreakdown');
    if (j.by_category && Object.keys(j.by_category).length > 0) {
      let html = '<table><tr><th>Category</th><th>Count</th><th>Total</th></tr>';
      for (const [cat, data] of Object.entries(j.by_category)) {
        html += `<tr><td>${cat}</td><td>${data.count}</td><td>$${data.total.toFixed(2)}</td></tr>`;
      }
      html += '</table>';
      breakdown.innerHTML = html;
    }
  }
}

async function refreshFiles() {
  const listEl = document.getElementById('fileList');
  listEl.textContent = 'Loading files...';
  
  const r = await fetch('/api/files/list', {headers: authHeaders()});
  const j = await r.json();
  
  if (!j.ok) {
    listEl.textContent = `Error: ${j.error}`;
    return;
  }
  
  if (j.files.length === 0) {
    listEl.textContent = 'No files found in scans directory.';
    return;
  }
  
  let html = '';
  for (const file of j.files) {
    const isClassified = file.category !== null;
    html += `<div class="file-item ${isClassified ? 'classified' : 'unclassified'}">`;
    html += `<div class="file-info">`;
    html += `<div class="file-name">${file.name}</div>`;
    html += `<div class="file-meta">${file.size} â€¢ ${file.modified}</div>`;
    if (isClassified) {
      html += `<div style="margin-top: 0.5rem;">`;
      html += `<span class="category-badge">${file.category}</span>`;
      html += `<span class="confidence">${(file.confidence * 100).toFixed(1)}% confidence</span>`;
      if (file.amount) {
        html += `<span style="margin-left: 1rem; color: #4caf50; font-weight: bold;">$${parseFloat(file.amount).toFixed(2)}</span>`;
      }
      html += `</div>`;
    }
    html += `</div>`;
    if (!isClassified) {
      html += `<button onclick="classifyFile('${file.name}')" class="small">Classify</button>`;
    }
    html += `</div>`;
  }
  
  listEl.innerHTML = html;
}

async function classifyFile(filename) {
  showStatus('Classifying ' + filename + '...', 'info');
  
  const r = await fetch('/api/classify', {
    method: 'POST',
    headers: {...authHeaders(), 'Content-Type': 'application/json'},
    body: JSON.stringify({filename: filename})
  });
  
  const j = await r.json();
  
  if (j.ok) {
    showStatus(`âœ“ Classified: ${j.category} (${(j.confidence * 100).toFixed(1)}% confidence)`, 'success');
    refreshFiles();
    checkExpenseSummary();
  } else {
    showStatus(`âœ— Classification failed: ${j.error}`, 'error');
  }
}

async function classifyAll() {
  const btn = document.getElementById('classifyAllBtn');
  btn.disabled = true;
  btn.textContent = 'Classifying...';
  showStatus('Classifying all files...', 'info');
  
  const r = await fetch('/api/classify/all', {
    method: 'POST',
    headers: authHeaders()
  });
  
  const j = await r.json();
  
  if (j.ok) {
    showStatus(`âœ“ Classified ${j.classified} files. ${j.failed > 0 ? j.failed + ' failed.' : ''}`, 'success');
    refreshFiles();
    checkExpenseSummary();
  } else {
    showStatus(`âœ— Classification failed: ${j.error}`, 'error');
  }
  
  btn.disabled = false;
  btn.textContent = 'Classify All Files';
}

function showStatus(message, type) {
  const el = document.getElementById('statusMessage');
  el.className = `status-message ${type}`;
  el.textContent = message;
  el.style.display = 'block';
  if (type === 'success' || type === 'info') {
    setTimeout(() => { el.style.display = 'none'; }, 5000);
  }
}

async function downloadExpenses() {
  window.location.href = '/api/expenses/download?token=' + TOKEN;
}

// Initialize
checkMLStatus();
refreshFiles();
checkExpenseSummary();
setInterval(() => { refreshFiles(); checkExpenseSummary(); }, 30000);
</script>
</body>
</html>

